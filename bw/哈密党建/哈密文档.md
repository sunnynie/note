# 月积分修改
1. 为公示之前红黄榜为空,公示后按照原来的规则
2. 未公示,积分榜展示积分申报状态和分值,根据分数和规则动态排名
   - 未申报,默认积分为空
   - 待审核时,展示个人申报积分
   - 待复核时,展示支部审核积分
   - 待公示时,展示支部复核积分
   - 申述待审核,申述待复核,申述待公示时,展示申述的积分
   - 积分为0需排在空之前,为空的不支持数据穿透,其他状态时需要支持数据穿透,可看出相应的积分情况
3. 公示之后,积分榜展现的内容与现有一致,积分列表支持点击穿透,查看已公示状态的积分情况

# 前端需要字段
- applyCheckDescription 复核说明
- applyExamineDescription 审核说明
- appealDescription 申诉说明(之前应该有这个字段)

# 积分审核,复核,申述,添加说明
```sql
ALTER TABLE hmdj_evaluate_result ADD APPLY_CHECK_DESCRIPTION varchar(600) CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '复核分数说明';
ALTER TABLE hmdj_evaluate_result ADD APPLY_EXAMINE_DESCRIPTION varchar(600) CHARACTER SET utf8 COLLATE utf8_general_ci NULL COMMENT '审核分数说明';
```


# app 会签问题
- 会签状态通过字典获取,还是有可能出现顺序混乱的情况

# 月积分各个状态查询sql
```sql
select
	hpet.ID ,hpet.APPLY_YEAR ,hpet.APPLY_MONTH ,hpet.PARTY_BRANCH_ID ,hpet.PARTY_BRANCH_NAME ,hpet.PMEMBER_ID ,hpet.TASK_STATUS ,
	case when hpet.TASK_STATUS ='2' then hpet.APPLY_EXAMINE_SCORE 
	 	 when hpet.TASK_STATUS ='3' then hpet.APPLY_CHECK_SCORE 
		 when hpet.TASK_STATUS ='8' then hpet.APPEAL_SCORE 
		 when hpet.TASK_STATUS in('6','7') then hpet. APPLY_CHECK_SCORE
		 when hpet.TASK_STATUS in('4','5') and hpet.APPEAL_RESULT ='agree' then hpet.APPEAL_SCORE 
		 when hpet.TASK_STATUS in('4','5') and (hpet.APPEAL_RESULT !='agree' or hpet.APPEAL_RESULT is null) then hpet.APPLY_CHECK_SCORE
	end
from
	hmdj_pmember_evaluation_task hpet
where  hpet.TASK_STATUS in ('2','3','4','5','6','7')
```

# 我的积分测试
- 用户:杨超 2b5f1575-a01d-4998-80a4-26b8c11a6d40
- 月度 :7 月份 黄榜
  - 7 月份的规则
  - 所在的名词
- 月度: 6 月份 无标签
- 问题
  - 计算问题,之前生成的rangking 排名的实际分数和后面计算分数,是否会有冲突
# 模板数据保存,清楚之前的旧数据
```sql
delete from hmdj_evaluate_template 

curl http://10.1.18.58:18888/hmdj-facade/hmdj/hmdjEvaluateVersion/testPublishTask  (需要换成对应的服务器地址)
```

# app 状态修改 (sql 内容更新,删除之前的数据,后更新数据)
```sql 

delete from t_dict_code where dict_id ='hqztid'
delete from  t_dict_info  where dict_id ='hqztid'

INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid1', 'hqztid', '5', '已发布', 4, '', '', '已发布');
INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid2', 'hqztid', '4', '待发布', 3, '', '', '待发布');
INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid3', 'hqztid', '2', '已会签', 2, '', '', '已会签');
INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid4', 'hqztid', '1', '待会签', 1, '', '', '待会签');
INSERT INTO t_dict_info
(dict_id, dict_eng, dict_chn, dict_status, remark)
VALUES('hqztid', 'hqzt', '会签状态', '1', '会签状态');
```
# 08-01
- 积分榜涉及每个月进行任务计算处理, 五月中旬和六月中旬,无需做过多的判断,取的是月任务表
- 查询部门下的人员 (userId=10000,  没有在部门中)
  ```sql 
  select hpo.USER_ID  from t_base_dept tbd
	left join hmdj_party_operator hpo on
	hpo .PART_BRANCH_ID =tbd.ID  
	where tbd .id='5480704bbd164895ba774e5369c95714' 
  ```
#  7-31
- 排行榜规则修改 :添加date 字段,查询和保存都添加date 字段
- 查询规则,需要将当前的用户列表大小传入


# 2023-07-28 补充sql
```sql
-- 添加date 字段
ALTER TABLE hmdj_evaluate_rules ADD `date` varchar(20) NULL COMMENT '日期字符串,年月季度';
-- 将之前的老规则删除
delete from hmdj_evaluate_rules where 'date' is null;
```

# 积分排行榜逻辑
## 积分榜保存到数据库设计
- 当前规则信息加入到逻辑处理中
- 根据个人积分申报计划,获取当月排名信息
- 需要记录的数据: 
  - 人员的积分
  - 人员信息:id,姓名,头像1
  - 部门信息
  - 是否有标签(红榜,黄榜,季度和年度的前几名)
  - 年份,季度,月份
  - 时间类型
- 步骤:
  1. 根据类型和部门id,查询数据
  2. 分别保存到数据库中,根据(1) 条件查询内容,检查是否有数据,如果没有缓存,就重新计算进行保存 (存不存在,保存的数据不完整,第一次保存的数据不完整的问题)
  3. 个人积分的统计计算: 根据用户id,进行排序,取出对应的数据
  4. 每个月的总分获取, 总分的获取是每个月获取的
  5. 维度当前部门,时间类型,时间,年月,季度
## 查询部门下的人员
```sql
select count(*) from hmdj_party_operator where PART_BRANCH_ID ='571da461b4a7aaf382dc624dfd4e5288'
```
## 查询总分数
``` sql
select
	case
		when sum(hec.SCORE) is null then 0
		when sum(hec.SCORE) is not null then sum(hec.SCORE)
	end as totalScore
from
	hmdj_evaluate_content hec
left join hmdj_evaluate_type het on
	hec.TYPE_ID = het .ID
left join hmdj_evaluate_version hev on
	hev.ID = het.VERSION_ID
left join hmdj_evaluate_group heg on
	heg.ID = hev.GROUP_ID
where
	hev.STATUS = '5'
	and heg.DELETED = '0'
	and heg.dept_id = '571da461b4a7aaf382dc624dfd4e5288'
```
## 查询规则
```sql
SELECT t.party_branch_id AS partyBranchId, t.rule1 AS rule1, t.type AS type, t.rule2 AS rule2 FROM hmdj_evaluate_rules t WHERE t.type = '月度' and t.party_branch_id = '571da461b4a7aaf382dc624dfd4e5288'
```
## 查询部门下的人员分数
```sql
select
	t.id as id,
	t.apply_year as applyYear,
	t.apply_month as applyMonth,
	t.pmember_id as pmemberId,
	t.party_branch_id as partyBranchId,
	t.party_branch_name as partyBranchName,
	t.month_task_id as monthTaskId,
	t.apply_time as applyTime,
	t.apply_examine_time as applyExamineTime,
	t.apply_check_time as applyCheckTime,
	t.apply_score as applyScore,
	t.apply_examine_score as applyExamineScore,
	t.apply_check_score as applyCheckScore,
	t.task_status as taskStatus,
	t.apply_examiner_id as applyExaminerId,
	t.apply_checker_id as applyCheckerId,
	t.announcer_id as announcerId,
	t.pmember_name as pmemberName,
	t.return_flag as returnFlag,
	t.first_veto_flag as firstVetoFlag,
	t.second_veto_flag as secondVetoFlag,
	t.ranking as ranking,
	t.billboard_state as billboardState,
	t.performance as performance,
	t.apply_deadline as applyDeadline,
	t.group_id as groupId,
	t.version_id as versionId,
	t.appeal_result as appealResult,
	t.appeal_score as appealScore,
	t.appeal_time as appealTime,
	t.appeal_review_time as appealReviewTime,
	t.appeal_check_time as appealCheckTime
from
	hmdj_pmember_evaluation_task t
where
	t.apply_year = '2023'
	and t.apply_month = '07'
	and t.party_branch_id = '571da461b4a7aaf382dc624dfd4e5288'
	and t.task_status in ( '4' , '5' ) 
	-- 状态 4,5 分别是 公示和不公示的状态,都是进行积分审批之后,才有的状态
order by
	convert(t.APPLY_CHECK_SCORE,
	SIGNED) desc
```
# sql 文档
``` sql
-- 积分榜规则
-- hmdj.hmdj_evaluate_rules definition

CREATE TABLE `hmdj_evaluate_rules` (
  `party_branch_id` varchar(100) DEFAULT NULL COMMENT '党支部id',
  `rule1` varchar(10) DEFAULT NULL COMMENT '规则1',
  `type` varchar(100) DEFAULT NULL COMMENT '类型: 1.月度,2.季度3.年度',
  `rule2` varchar(10) DEFAULT NULL COMMENT '规则2'
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='积分榜规则';



-- hmdj_new.hmdj_evaluate_template definition

CREATE TABLE `hmdj_evaluate_template` (
  `id` varchar(40) NOT NULL,
  `dw_id` varchar(40) DEFAULT NULL COMMENT '党委id',
  `dw_name` varchar(100) DEFAULT NULL COMMENT '党委名称',
  `evaluate_id` varchar(100) DEFAULT NULL COMMENT '指数模板',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `create_by` varchar(100) DEFAULT NULL COMMENT '创建者',
  `evaluate_name` varchar(100) DEFAULT NULL COMMENT '评价指数名称',
  `dzb_id` varchar(100) DEFAULT NULL COMMENT '党支部id',
  `dzb_name` varchar(100) DEFAULT NULL COMMENT '党支部名称',
  `create_id` varchar(100) DEFAULT NULL COMMENT '创建者id',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='评价模板';


//补充sql
drop table if exists `hmdj_evaluate_group_sign` 
CREATE TABLE `hmdj_evaluate_group_sign` (
  `id` varchar(40) DEFAULT NULL COMMENT 'id',
  `evaluate_group_id` varchar(40) DEFAULT NULL COMMENT '指标分组id',
  `user_id` varchar(40) DEFAULT NULL COMMENT '用户id',
  `deal_result` varchar(10) DEFAULT NULL COMMENT '0. 未处理 1.同意 2. 不同意',
  `one_sign` varchar(10) DEFAULT NULL COMMENT '一键会签 0.否 1. 是',
  `deal_end` varchar(10) DEFAULT NULL COMMENT '处理结束 0.否 1.是',
  `create_time` timestamp NULL DEFAULT NULL COMMENT '创建时间',
  `update_time` timestamp NULL DEFAULT NULL COMMENT '更新时间',
  KEY `hmdj_evaluate_group_sign_user_id_IDX` (`user_id`) USING BTREE,
  KEY `hmdj_evaluate_group_sign_evaluate_group_id_IDX` (`evaluate_group_id`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='评价指标会签表';

INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid4', 'hqztid', '0', '待会签', 8, '', '', '待会签');
INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid3', 'hqztid', '0', '已会签', 8, '', '', '已会签');
INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid2', 'hqztid', '0', '待发布', 8, '', '', '待发布');
INSERT INTO t_dict_code
(code_id, dict_id, code_value, code_desc, priority, parent_value, children_text, code_key)
VALUES('hqcodeid1', 'hqztid', '0', '已发布', 8, '', '', '已发布');

INSERT INTO t_dict_info
(dict_id, dict_eng, dict_chn, dict_status, remark)
VALUES('hqztid', 'hqzt', '会签状态', '1', '会签状态');

```

# 会签
- 待会签,将会签的待发布,和已发布的都设置成未

# 模板功能
- 评价体系管理, 将已有的数据,设置成模板
  包括: 党委,党支部,评价指数
- 将模板里面关联的内容复制,指定的分类下

# 积分排行榜
- 查询列表分类: 
  - 月度
  - 季度
  - 年度
- 规则: 根据党支部,时间维度,查询 每个列表查询列表的比例
- 具体查询: 根据规则查询头部具体显示的比例
- 接口的划分:
  - 根据查询头部列表的数据
  - 根据原来的列表查询分页

# 访问数据库
- facade 数据库
  - mysql (主库)
    - url:jdbc:mysql://10.1.18.47:13316/hmdj
    - userName: root
    - password: Xj_xm123
  - oracle (从库)
    - url: jdbc:oracle:thin:@192.168.19.170:1521:xjxm
    - userName: hmdjuser
    - password: Xj_xm123!
- frapi 数据库
  - oracle 
    - url: jdbc:oracle:thin:@192.168.19.170:1521:xjxm
    - userName: hmdjuser
    - password: Xj_xm123!
# 访问地址
- 本地开发环境
  - app
    - http://localhost:8080/#/
  - web 
    - http://localhost:18080/hmdj/pointsReview
# app 登录
- 后端  
   放行 /hmdj/sys/getUserInfoApp

# 账号
- authManager  Booway@1
- lgm  