# jvm方法内联优化
## 前言
在日常的工作中，会时不时的对代码进行优化，比如用新的算法，简化设计等。对于java程序中，除了开发者本身对代码优化之外，还有jvm也会优化代码。jvm会帮我们分析出热点代码，优化代码逻辑。其中之一就是：方法内联优化。
## 方法内联
什么交方法内联，又叫函数内联，java中方法可等同于其他语言的函数。关于方法内联维基百科解释：

        在计算机科学中，内联函数（有时又称作在线函数或者编译期展开函数）是一种编程语言结构中用来建议编  
        译器对一些特殊函数进行内联扩展（有时又称作在线扩展）；  
        也就是说建议编译器指定的函数插入并取代每一处调用该函数的地方（上下文）,从而节省了每次调用函数的额外时间开支。
        
通俗简单的讲就是把方法内部调用的其他的方法的逻辑，嵌入到自身的方法中，变成自身的部分，之后不再调用该方法，从而节省调用函数带来额外的开支。

## 函数调用开销
之所以出现方法内联是因为函数调用除了执行自身逻辑的开销外，还有一些不为人知的开销，这部分开销主要来自方法栈帧的生成，参数字段的压入，栈帧的弹出，还有指令执行的跳转。比如有下面的这样的代码：

```java
public static void functionA(int a,int b){
    functionB(a,b);
}
public static void functionB(int c,int d){
    //do something
}

public static void main(String[] args){
    functionA(1,2);
} 
```
![](https://gitee.com/shuanger_nie/images/raw/master/note/java_base/jvm方法内联优化.md/371185809248788.png)

很有可能自身执行的逻辑的开销还比不上为了调用这个方法的额外开销，如果类似的方法被频繁调用，则真正的对执行效率就会很低，虽然这类的方法的执行时间很短，这也是为什么jvm会再热点代码中执行方法内联的原因，这样的话就可以省去调用函数带来的额外支出。
### 内联之前的形式
```java
public int add(int a,int b,int c,int d){
    return add(a,b)+add(c,d);
}

public int add(int a,int b){
    return a+b;
}
```
### 内联之后的形式
```java
public int add(int a,int b,int c ,int d){
    return a+b+c+d;
}
```
## 内联条件
一个方法如果要满足以下条件就可能被jvm内联
1. 热点代码，如果一个方法执行频率很高就表示优化的潜在价值就很大，那代码执行多少次数能确定为热点代码，这时根据编译器模式来确定的，如果是客户端编译模式则次数的1500，服务端编译模式是10000，次数大小可以通过-XX:CompileThreshold来调整。
2. 方法体不能太大。jvm中被内联的方法会变成机器码放在code-cache中。如果方法太大则能缓存的方法就少，反而影响性能。
3. 如果希望方法被内联，尽量用private,statis,final修饰，这样的jvm可以 直接内联，如果是public protected修饰方法，jvm则需要进行类型判断，因为这些可以被子类继承和覆盖，jvm需要判断内联是父类还是子类的某个方法

